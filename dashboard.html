<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Особистий кабінет - SoulCraft</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="button">На головну</a>
            <div class="nav-links">
                <a href="shop.html" class="button">Магазин</a>
                
                <a href="cart.html" class="button" id="cart-link" style="display: none;">
                    Корзина
                    <span id="cart-count" class="cart-count-badge" style="display: none;">0</span>
                </a>

                <button id="logout-button" class="button">Вийти</button>
            </div>
        </nav>
    </header>

    <main class="dashboard-container">
        
        <div class="tab-nav">
            <button class="tab-button active" data-tab="profile-tab">Ваш профіль</button>
            <button class="tab-button" data-tab="seller-tab" id="seller-tab-button" style="display: none;">Панель Продавця</button>
        </div>

        <div id="general-status" class="status-message" style="display:none;"></div>

        <div id="profile-tab" class="tab-content active">
            <h1>Ваш профіль</h1>
            <div class="profile-layout">
                <div class="profile-pic-container">
                    <img src="" alt="Ваше фото профілю" id="profile-pic-display" class="profile-pic">
                    <div id="profile-pic-placeholder" class="profile-pic-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A1.5 1.5 0 0118 21.75H6.001c-.621 0-1.125-.504-1.125-1.125a1.5 1.5 0 01.624-1.507z" />
                        </svg>
                    </div>
                    <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
                    <button id="upload-pic-button" class="button button-primary">Змінити фото</button>
                    <button id="save-pic-button" class="button" style="display:none;">Зберегти фото</button>
                </div>
                <div class="profile-info-container">
                    <form id="profile-form">
                        <label for="email-display">Email (не можна змінити)</label>
                        <input type="email" id="email-display" disabled>
                        <label for="name">Ваше ім'я</label>
                        <input type="text" id="name" placeholder="Введіть ваше ім'я">
                        <label for="city">Місто</label>
                        <input type="text" id="city" placeholder="Звідки ви?">
                        <label for="phone">Номер телефону</label>
                        <input type="tel" id="phone" placeholder="+380...">
                        <button type="submit" class="button button-primary">Зберегти профіль</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="seller-tab" class="tab-content">
            <section id="seller-panel" class="seller-panel">
                <h2>Панель Продавця</h2>
                <form id="add-product-form">
                    <h3>Додати новий товар</h3>
                    <label for="product-name">Назва товару</label>
                    <input type="text" id="product-name" required>
                    <label for="product-desc">Короткий опис товару</label>
                    <textarea id="product-desc" rows="3" required></textarea>
                    <label for="product-story">Історія предмету (необов'язково)</label>
                    <textarea id="product-story" rows="5" placeholder="Розкажіть, що робить цей предмет особливим..."></textarea>
                    <label for="product-category">Категорія</label>
                    <select id="product-category" required>
                        <option value="" disabled selected>Оберіть категорію</option>
                        <option value="jewelry">Прикраси</option>
                        <option value="boxes">Скриньки</option>
                        <option value="oils">Олії та Есенції</option>
                        <option value="soap">Вироби з мила</option>
                        <option value="paintings">Картини</option>
                        <option value="other">Інше</option>
                    </select>
                    <label for="product-price">Ціна (у грн)</label>
                    <input type="number" id="product-price" required>
                    
                    <label for="product-image-file">Фото товару</label>

                    <input type="file" id="product-image-file" accept="image/*" required style="display: none;">

                    <div class="custom-file-input">
                        <button type="button" class="button" id="custom-file-button">Вибрати файл</button>
                        <span id="custom-file-text">Файл не вибрано</span>
                    </div>
                    
                    <button type="submit" class="button button-primary" id="add-product-button">Додати товар</button>
                </form>
                
                </section> 
        
        </div> 

    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // ВАШІ КЛЮЧІ
        const firebaseConfig = {
          apiKey: "AIzaSyDI1y9z3JqGwjOYacWsHZgPhU038YBz9pA",
          authDomain: "soulcraft-project.firebaseapp.com",
          projectId: "soulcraft-project",
          storageBucket: "soulcraft-project.firebasestorage.app",
          messagingSenderId: "442181022403",
          appId: "1:442181022403:web:590c4523ebcc12213c2876"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // (Отримуємо всі елементи)
        const emailDisplay = document.getElementById('email-display');
        const nameInput = document.getElementById('name');
        const cityInput = document.getElementById('city');
        const phoneInput = document.getElementById('phone');
        const profileForm = document.getElementById('profile-form');
        const logoutButton = document.getElementById('logout-button');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const profilePicPlaceholder = document.getElementById('profile-pic-placeholder');
        const uploadPicButton = document.getElementById('upload-pic-button');
        const photoUploadInput = document.getElementById('photo-upload-input');
        const savePicButton = document.getElementById('save-pic-button');
        const generalStatusDiv = document.getElementById('general-status');
        const sellerPanel = document.getElementById('seller-panel');
        const addProductForm = document.getElementById('add-product-form');
        const addProductButton = document.getElementById('add-product-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const sellerTabButton = document.getElementById('seller-tab-button');
        
        // (Отримуємо елементи для кастомної кнопки файлу)
        const productImageFileInput = document.getElementById('product-image-file');
        const customFileButton = document.getElementById('custom-file-button');
        const customFileText = document.getElementById('custom-file-text');
        
        const cartLink = document.getElementById('cart-link');
        const cartCountBadge = document.getElementById('cart-count');

        let currentUser = null; 
        let selectedFile = null; 

        // --- ОНОВЛЕННЯ ЛІЧИЛЬНИКА КОРЗИНИ ---
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('soulcraftCart')) || [];
            if (cart.length > 0) {
                cartCountBadge.textContent = cart.length;
                cartCountBadge.style.display = 'flex';
            } else {
                cartCountBadge.style.display = 'none';
            }
        }

        // --- Функція для показу повідомлень ---
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status-message ' + type;
            element.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { element.style.display = 'none'; }, 5000);
            }
        }

        // --- ГОЛОВНА ФУНКЦІЯ (АВТЕНТИФІКАЦІЯ) ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user.uid, user.email);
                
                if (user.emailVerified) {
                    cartLink.style.display = 'inline-flex';
                    updateCartCount();
                } else {
                    alert("Ваш акаунт ще не активовано. Будь ласка, підтвердіть пошту.");
                    cartLink.style.display = 'none';
                }
                
            } else {
                alert("Будь ласка, увійдіть, щоб побачити ваш профіль.");
                window.location.href = 'login.html';
            }
        });

        // --- 1. ЗАВАНТАЖЕННЯ ДАНИХ ---
        async function loadUserProfile(uid, email) {
            emailDisplay.value = email;
            const userDocRef = db.collection('users').doc(uid);
            const doc = await userDocRef.get();
            if (doc.exists) {
                const data = doc.data();
                nameInput.value = data.name || '';
                cityInput.value = data.city || '';
                phoneInput.value = data.phone || '';
                if (data.photoURL) {
                    profilePicDisplay.src = data.photoURL;
                    profilePicDisplay.style.display = 'block';
                    profilePicPlaceholder.style.display = 'none';
                } else {
                    profilePicDisplay.style.display = 'none';
                    profilePicPlaceholder.style.display = 'block';
                }
                if (data.role === 'seller') {
                    sellerTabButton.style.display = 'inline-block';
                }
            } else {
                // (Якщо раптом документа немає, створюємо)
                userDocRef.set({ name: '', city: '', phone: '' }); 
                profilePicPlaceholder.style.display = 'block';
            }
        }

        // --- 2. ЗБЕРЕЖЕННЯ ДАНИХ ПРОФІЛЮ ---
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            if (!currentUser.emailVerified) {
                 showStatus(generalStatusDiv, "Для збереження даних профілю спочатку підтвердіть свою пошту.", 'error');
                return;
            }
            const userDocRef = db.collection('users').doc(currentUser.uid);
             try {
                await userDocRef.set({
                    name: nameInput.value,
                    city: cityInput.value,
                    phone: phoneInput.value
                }, { merge: true }); 
                showStatus(generalStatusDiv, "Профіль успішно збережено!", 'success');
             } catch (error) {
                showStatus(generalStatusDiv, "Помилка: " + error.message, 'error');
             }
        });

        // --- 3. ЛОГІКА ЗАВАНТАЖЕННЯ ФОТО ПРОФІЛЮ ---
        uploadPicButton.addEventListener('click', () => photoUploadInput.click());
        photoUploadInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    profilePicDisplay.src = event.target.result;
                    profilePicDisplay.style.display = 'block';
                    profilePicPlaceholder.style.display = 'none';
                }
                reader.readAsDataURL(selectedFile);
                savePicButton.style.display = 'inline-block';
            }
        });
        savePicButton.addEventListener('click', async () => {
             if (!currentUser || !selectedFile) return;
             if (!currentUser.emailVerified) {
                showStatus(generalStatusDiv, "Для завантаження фото спочатку підтвердіть свою пошту.", 'error');
                return;
           }
             savePicButton.textContent = "Завантаження...";
             const storageRef = storage.ref(`profile_pics/${currentUser.uid}`);
             try {
                const task = await storageRef.put(selectedFile);
                const downloadURL = await task.ref.getDownloadURL();
                const userDocRef = db.collection('users').doc(currentUser.uid);
                await userDocRef.set({ photoURL: downloadURL }, { merge: true });
                window.location.reload(); 
             } catch (error) {
                showStatus(generalStatusDiv, "Помилка завантаження фото: " + error.message, 'error');
                savePicButton.textContent = "Зберегти фото";
             }
        });

        // --- 4. ВИХІД ---
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                localStorage.removeItem('soulcraftCart');
                window.location.href = 'index.html';
            }).catch((error) => console.error("Помилка виходу: ", error));
        });
        
        // --- 5. ЛОГІКА ДОДАВАННЯ ТОВАРУ ---
        if (addProductForm) {
            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return;

                const productName = document.getElementById('product-name').value;
                const productDesc = document.getElementById('product-desc').value;
                const productStory = document.getElementById('product-story').value;
                const productCategory = document.getElementById('product-category').value;
                const productPrice = Number(document.getElementById('product-price').value);
                
                // (Отримуємо файл зі схованого інпута)
                const imageFile = productImageFileInput.files[0]; 

                if (!productName || !productDesc || !productPrice || !imageFile || !productCategory) {
                    showStatus(generalStatusDiv, "Будь ласка, заповніть всі обов'язкові поля", 'error');
                    return;
                }

                addProductButton.textContent = "Завантаження...";
                addProductButton.disabled = true;
                
                try {
                    const productDocRef = db.collection('products').doc();
                    const storageRef = storage.ref(`product_images/${currentUser.uid}/${productDocRef.id}`);
                    const task = await storageRef.put(imageFile);
                    const downloadURL = await task.ref.getDownloadURL();
                    
                    await productDocRef.set({
                        name: productName,
                        description: productDesc,
                        story: productStory, 
                        category: productCategory,
                        price: productPrice,
                        imageUrl: downloadURL, 
                        sellerId: currentUser.uid,
                        status: "pending" 
                    });
                    
                    showStatus(generalStatusDiv, "Товар успішно додано! Він з'явиться в магазині після перевірки.", 'success');
                    addProductForm.reset();
                    // (Скидаємо текст фейкової кнопки)
                    customFileText.textContent = 'Файл не вибрано';
                    customFileText.style.color = 'var(--color-secondary)';
                    
                } catch (error) {
                    console.error("Помилка додавання товару: ", error);
                    showStatus(generalStatusDiv, "Помилка додавання товару: " + error.message, 'error');
                } finally {
                    addProductButton.textContent = "Додати товар";
                    addProductButton.disabled = false;
                }
            });
        }

        // --- 6. ЛОГІКА ДЛЯ "ФЕЙКОВОЇ" КНОПКИ ЗАВАНТАЖЕННЯ ---
        if (customFileButton) {
            customFileButton.addEventListener('click', () => {
                productImageFileInput.click(); 
            });

            productImageFileInput.addEventListener('change', () => {
                if (productImageFileInput.files.length > 0) {
                    customFileText.textContent = productImageFileInput.files[0].name;
                    customFileText.style.color = 'var(--color-text)';
                } else {
                    customFileText.textContent = 'Файл не вибрано';
                    customFileText.style.color = 'var(--color-secondary)';
                }
            });
        }
        
        // --- 7. ЛОГІКА ДЛЯ ВКЛАДОК ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

    </script>
</body>
</html>
