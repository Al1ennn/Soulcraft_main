<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Особистий кабінет - SoulCraft</title>
    <link rel="stylesheet" href="style.css">
    <!-- Підключаємо шрифти -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo-nav">SoulCraft</a>
            <div class="nav-links">
                <!-- Кнопка "Вийти" з'явиться тут -->
                <button id="logout-button" class="button">Вийти</button>
            </div>
        </nav>
    </header>

    <main class="dashboard-container">
        <h1>Ваш профіль</h1>
        
        <div class="profile-layout">
            
            <!-- ЛІВА КОЛОНКА: ФОТО -->
            <div class="profile-pic-container">
                <img src="" alt="Ваше фото профілю" id="profile-pic-display" class="profile-pic">
                
                <!-- Заглушка, якщо фото немає -->
                <div id="profile-pic-placeholder" class="profile-pic-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A1.5 1.5 0 0118 21.75H6.001c-.621 0-1.125-.504-1.125-1.125a1.5 1.5 0 01.624-1.507z" />
                    </svg>
                </div>

                <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
                <button id="upload-pic-button" class="button button-primary">Змінити фото</button>
                <button id="save-pic-button" class="button" style="display:none;">Зберегти фото</button>
            </div>

            <!-- ПРАВА КОЛОНКА: ІНФОРМАЦІЯ -->
            <div class="profile-info-container">
                <form id="profile-form">
                    <label for="email-display">Email (не можна змінити)</label>
                    <input type="email" id="email-display" disabled>
                    
                    <label for="name">Ваше ім'я</label>
                    <input type="text" id="name" placeholder="Введіть ваше ім'я">
                    
                    <label for="city">Місто</label>
                    <input type="text" id="city" placeholder="Звідки ви?">
                    
                    <label for="phone">Номер телефону</label>
                    <input type="tel" id="phone" placeholder="+380...">
                    
                    <button type="submit" class="button button-primary">Зберегти профіль</button>
                </form>
            </div>

        </div>
    </main>

    <!-- ======== БЛОК FIREBASE (ВСЯ ЛОГІКА ТУТ) ======== -->
    
    <!-- Підключаємо всі 4 сервіси Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // ВАШІ КЛЮЧІ
        const firebaseConfig = {
          apiKey: "AIzaSyDI1y9z3JqGwjOYacWsHZgPhU038YBz9pA",
          authDomain: "soulcraft-project.firebaseapp.com",
          projectId: "soulcraft-project",
          storageBucket: "soulcraft-project.firebasestorage.app",
          messagingSenderId: "442181022403",
          appId: "1:442181022403:web:590c4523ebcc12213c2876"
        };

        // Ініціалізуємо Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Отримуємо елементи зі сторінки
        const emailDisplay = document.getElementById('email-display');
        const nameInput = document.getElementById('name');
        const cityInput = document.getElementById('city');
        const phoneInput = document.getElementById('phone');
        const profileForm = document.getElementById('profile-form');
        const logoutButton = document.getElementById('logout-button');
        
        // Елементи для фото
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const profilePicPlaceholder = document.getElementById('profile-pic-placeholder');
        const uploadPicButton = document.getElementById('upload-pic-button');
        const photoUploadInput = document.getElementById('photo-upload-input');
        const savePicButton = document.getElementById('save-pic-button');

        let currentUser = null; // Зберігаємо тут дані користувача
        let selectedFile = null; // Зберігаємо обраний файл

        // ГОЛОВНА ФУНКЦІЯ: Перевірка, чи користувач увійшов
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Користувач увійшов
                currentUser = user;
                loadUserProfile(user.uid, user.email);
            } else {
                // Користувач не увійшов - відправляємо на сторінку входу
                alert("Будь ласка, увійдіть, щоб побачити ваш профіль.");
                window.location.href = 'login.html';
            }
        });

        // 1. ЗАВАНТАЖЕННЯ ДАНИХ
        async function loadUserProfile(uid, email) {
            emailDisplay.value = email; // Показуємо email

            // Отримуємо документ користувача з Firestore
            const userDocRef = db.collection('users').doc(uid);
            const doc = await userDocRef.get();

            if (doc.exists) {
                const data = doc.data();
                nameInput.value = data.name || '';
                cityInput.value = data.city || '';
                phoneInput.value = data.phone || '';
                
                if (data.photoURL) {
                    profilePicDisplay.src = data.photoURL;
                    profilePicDisplay.style.display = 'block';
                    profilePicPlaceholder.style.display = 'none';
                } else {
                    profilePicDisplay.style.display = 'none';
                    profilePicPlaceholder.style.display = 'block';
                }
            } else {
                // Якщо документа ще немає, просто показуємо заглушку
                profilePicDisplay.style.display = 'none';
                profilePicPlaceholder.style.display = 'block';
            }
        }

        // 2. ЗБЕРЕЖЕННЯ ДАНИХ ПРОФІЛЮ (Ім'я, місто, телефон)
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const userDocRef = db.collection('users').doc(currentUser.uid);
            
            try {
                await userDocRef.set({
                    name: nameInput.value,
                    city: cityInput.value,
                    phone: phoneInput.value
                }, { merge: true }); // { merge: true } щоб не перезаписати фото
                
                alert("Профіль успішно збережено!");
            } catch (error) {
                console.error("Помилка збереження профілю: ", error);
                alert("Помилка: " + error.message);
            }
        });

        // 3. ЛОГІКА ЗАВАНТАЖЕННЯ ФОТО
        
        // Крок А: Клік по кнопці "Змінити фото" відкриває прихований input
        uploadPicButton.addEventListener('click', () => {
            photoUploadInput.click();
        });

        // Крок Б: Коли користувач обрав файл
        photoUploadInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                // Показуємо прев'ю
                const reader = new FileReader();
                reader.onload = (event) => {
                    profilePicDisplay.src = event.target.result;
                    profilePicDisplay.style.display = 'block';
                    profilePicPlaceholder.style.display = 'none';
                }
                reader.readAsDataURL(selectedFile);
                
                // Показуємо кнопку "Зберегти фото"
                savePicButton.style.display = 'inline-block';
            }
        });

        // Крок В: Клік по кнопці "Зберегти фото"
        savePicButton.addEventListener('click', async () => {
            if (!currentUser || !selectedFile) return;

            savePicButton.textContent = "Завантаження...";
            
            // Створюємо посилання на Firebase Storage
            const storageRef = storage.ref(`profile_pics/${currentUser.uid}`);
            
            try {
                // Завантажуємо файл
                const task = await storageRef.put(selectedFile);
                
                // Отримуємо URL завантаженого файлу
                const downloadURL = await task.ref.getDownloadURL();
                
                // Оновлюємо фото в UI (хоча воно вже є з прев'ю)
                profilePicDisplay.src = downloadURL;
                
                // Зберігаємо URL у Firestore
                const userDocRef = db.collection('users').doc(currentUser.uid);
                await userDocRef.set({
                    photoURL: downloadURL
                }, { merge: true });

                alert("Фото профілю оновлено!");
                savePicButton.style.display = 'none'; // Ховаємо кнопку
                savePicButton.textContent = "Зберегти фото";
                selectedFile = null; // Скидаємо вибір

            } catch (error) {
                console.error("Помилка завантаження фото: ", error);
                alert("Помилка: " + error.message);
                savePicButton.textContent = "Зберегти фото";
            }
        });

        // 4. ВИХІД
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Помилка виходу: ", error);
            });
        });

    </script>
</body>
</html>
